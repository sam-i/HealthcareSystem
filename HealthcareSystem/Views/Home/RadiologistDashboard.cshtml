@model HealthcareSystem.ViewModels.RadiologistDashboardViewModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    var token = Antiforgery.GetAndStoreTokens(Context).RequestToken;
}
<form action="@Url.Action("Logout", "Radiologist")" method="post" style="position: absolute; top: 10px; right: 10px;">
    <button type="submit" class="btn btn-danger">Logout</button>
</form>
<div class="container-fluid scrollable-content">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h4>Patient List</h4>
                </div>
                <div class="card-body p-0">
                    @if (Model.Patients == null || !Model.Patients.Any())
                    {
                        <p class="text-center mt-3">No patients assigned</p>
                    }
                    else
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var patient in Model.Patients)
                            {
                                <a href="#"
                                   class="list-group-item list-group-item-action patient-select"
                                   data-patient-id="@patient.Id"
                                   data-patient-name="@patient.Name"
                                   data-patient-address="@patient.Address"
                                   data-patient-conditions="@patient.CurrentCondition">
                                    @patient.Name
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div id="patientDetailsSection" style="display:none;">
                <div class="card mb-3">
                    <div class="card-header">
                        <h4 id="patientDetailsHeader">Patient Details</h4>
                    </div>
                    <div class="card-body">
                        <form id="patientDetailsForm">
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label>Patient Name</label>
                                    <input type="text" class="form-control" id="patientName" readonly>
                                </div>
                                <div class="form-group col-md-6">
                                    <label>Assigned Doctor</label>
                                    <input type="text" class="form-control" id="patientDoctor" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Current Condition</label>
                                <textarea class="form-control" id="patientConditions" readonly rows="3"></textarea>
                            </div>
                        </form>
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <h5 class="mb-0">Uploaded Medical Images</h5>
                            <button id="uploadImageModalTrigger" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadImageModal">
                                Upload Image
                            </button>
                        </div>
                        <div id="patientImagesList" class="row mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="uploadImageModal" tabindex="-1" aria-labelledby="uploadImageModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadImageModalLabel">Upload Medical Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="uploadImageForm" method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" name="patientId" id="uploadPatientId" />
                        <input type="hidden" name="radiologistId" value="@Model.Radiologist.Id" />
                        <input type="hidden" name="__RequestVerificationToken" value="@token" />
                        <div class="form-group mb-3">
                            <label for="imageType">Image Type</label>
                            <select name="imageType" id="imageType" class="form-control" required>
                                <option value="">Select Image Type</option>
                                @foreach (var imageType in Enum.GetValues(typeof(ImageType)))
                                {
                                    <option value="@((int)imageType)">@imageType.ToString()</option>
                                }
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="imageCost">Image Cost</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number"
                                       id="imageCost"
                                       name="cost"
                                       step="0.01"
                                       min="0"
                                       class="form-control"
                                       required>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label for="imageFile">Upload Image</label>
                            <input type="file"
                                   class="form-control"
                                   id="imageFile"
                                   name="imageFile"
                                   accept=".jpg,.jpeg,.png,.dcm"
                                   required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="imageViewModal" tabindex="-1" aria-labelledby="imageViewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageViewModalLabel">Image Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="fullSizeImage" src="" class="img-fluid" alt="Medical Image">
                    <div id="imageDetails" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>
@section Scripts {
    <style>
        .scrollable-content {
            max-height: calc(100vh - 50px);
            overflow-y: auto;
            padding-right: 15px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showSuccessToast(message) {
            const toast = `
                        <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body">${message}</div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>`;
            $('#toastContainer').append(toast);
            const toastElement = $('.toast').last();
            const bsToast = new bootstrap.Toast(toastElement);
            bsToast.show();
            toastElement.on('hidden.bs.toast', function () {
                $(this).remove();
            });
        }

        function showErrorToast(message) {
            const toast = `
                        <div class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body">${message}</div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>`;

            $('#toastContainer').append(toast);
            const toastElement = $('.toast').last();
            const bsToast = new bootstrap.Toast(toastElement);
            bsToast.show();
            toastElement.on('hidden.bs.toast', function () {
                $(this).remove();
            });
        }

        function getImageTypeName(imageType) {
            switch (parseInt(imageType)) {
                case 1: return 'MRI';
                case 2: return 'CT';
                case 3: return 'X-Ray';
                default: return 'Unknown';
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }

        function loadPatientImages(patientId) {
            $.get('@Url.Action("GetPatientImages", "Radiologist")', { patientId: patientId })
                .done(function (images) {
                    const imagesList = $('#patientImagesList');
                    imagesList.empty();
                    if (!images || images.length === 0) {
                        imagesList.append('<div class="col-12"><p>No images uploaded yet.</p></div>');
                        return;
                    }
                    images.forEach(function (image) {
                        const cost = image.cost || 0;
                        const html = `
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <img src="/uploads/medical-images/${image.storagePath}"
                                                 class="card-img-top img-thumbnail cursor-pointer"
                                                 alt="Medical Image"
                                                 style="height: 200px; object-fit: cover;"
                                                 onclick="viewImage('${image.storagePath}', '${getImageTypeName(image.imageType)}', '${formatDate(image.uploadDate)}', ${cost})">
                                            <div class="card-body">
                                                <p class="card-text text-center">
                                                    ${getImageTypeName(image.imageType)}<br>
                                                    $${cost.toFixed(2)}
                                                </p>
                                                <div class="text-center">
                                                    <button onclick="deleteImage(${image.id}, '@Model.Radiologist.Id')"
                                                            class="btn btn-sm btn-outline-danger">
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>`;
                        imagesList.append(html);
                    });
                })
                .fail(function (xhr, status, error) {
                    console.error('Error loading images:', error);
                    $('#patientImagesList').html('<div class="col-12"><p class="text-danger">Error loading images.</p></div>');
                    showErrorToast('Error loading images');
                });
        }

        function viewImage(storagePath, imageType, uploadDate, cost) {
            $('#fullSizeImage').attr('src', `/uploads/medical-images/${storagePath}`);
            $('#imageDetails').html(`
                        <p><strong>Type:</strong> ${imageType}</p>
                        <p><strong>Uploaded:</strong> ${uploadDate}</p>
                        <p><strong>Cost:</strong> $${cost.toFixed(2)}</p>
                    `);
            const modal = new bootstrap.Modal(document.getElementById('imageViewModal'));
            modal.show();
        }

        function deleteImage(imageId, radiologistId) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }
            $.ajax({
                url: '@Url.Action("DeleteImage", "Radiologist")',
                type: 'POST',
                data: {
                    imageId: imageId,
                    radiologistId: radiologistId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (result) {
                    if (result.success) {
                        showSuccessToast(result.message);
                        loadPatientImages($('#uploadPatientId').val());
                    } else {
                        showErrorToast(result.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Delete error:', error);
                    showErrorToast('Error deleting image');
                }
            });
        }

        $(document).ready(function () {
            $('.patient-select').on('click', function (e) {
                e.preventDefault();
                $('.patient-select').removeClass('active');
                $(this).addClass('active');
                const patientId = $(this).data('patient-id');
                $('#patientName').val($(this).data('patient-name'));
                $('#patientAddress').val($(this).data('patient-address'));
                $('#patientConditions').val($(this).data('patient-conditions'));
                $('#uploadPatientId').val(patientId);
                $.get('@Url.Action("GetPatientDoctor", "Radiologist")', { patientId: patientId })
                    .done(function (result) {
                        $('#patientDoctor').val(result.doctorName || 'No Doctor Assigned');
                    })
                    .fail(function () {
                        $('#patientDoctor').val('Error loading doctor');
                    });
                $('#patientDetailsSection').show();
                loadPatientImages(patientId);
            });

            function cleanupModal() {
                const modal = document.getElementById('uploadImageModal');
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.dispose();
                }
                $('#uploadImageModal').modal('hide');
                $('#uploadImageForm')[0].reset();
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open').css('padding-right', '');
                $('#uploadImageModal').hide();
            }

            $('.btn-close').on('click', function () {
                cleanupModal();
            });

            $('.modal-footer .btn-secondary').on('click', function () {
                cleanupModal();
            });

            $('#uploadImageModal').on('click', function (e) {
                if (e.target === this) {
                    cleanupModal();
                }
            });
            
            $('#uploadImageForm').on('submit', function (e) {
                e.preventDefault();
                const formData = new FormData();
                const patientId = $('#uploadPatientId').val();
                const radiologistId = $('input[name="radiologistId"]').val();
                const imageType = $('#imageType').val();
                const cost = $('#imageCost').val();
                const imageFile = $('#imageFile')[0].files[0];
                const token = $('input[name="__RequestVerificationToken"]').first().val();
                if (!patientId || !radiologistId || !imageType || !cost || !imageFile) {
                    showErrorToast('Please fill in all required fields');
                    return;
                }
                formData.append('patientId', patientId);
                formData.append('radiologistId', radiologistId);
                formData.append('imageType', imageType);
                formData.append('cost', cost);
                formData.append('imageFile', imageFile);
                formData.append('__RequestVerificationToken', token);
                $.ajax({
                    url: '@Url.Action("UploadImage", "Radiologist")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (result) {
                        if (result.success) {
                            $('#uploadImageModal').modal('hide');
                            setTimeout(() => {
                                cleanupModal();
                                loadPatientImages($('#uploadPatientId').val());
                                showSuccessToast(result.message);
                            }, 100);
                        } else {
                            showErrorToast(result.message || 'Upload failed');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Upload error details:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        let errorMessage = 'Error uploading image';
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            errorMessage = errorResponse.message || errorMessage;
                        } catch (e) {
                            errorMessage += ': ' + (xhr.responseText || error);
                        }

                        showErrorToast(errorMessage);
                    }
                });
            });

            $('#uploadImageModalTrigger').on('click', function (e) {
                if (!$('#uploadPatientId').val()) {
                    e.preventDefault();
                    showErrorToast('Please select a patient first');
                    return;
                }
                const uploadModal = new bootstrap.Modal(document.getElementById('uploadImageModal'));
                uploadModal.show();
            });
        });
    </script>
}